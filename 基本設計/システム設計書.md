# HP2550 気象データ管理システム 基本設計書

## ⚠️ 重要な注意事項
**ソースファイルを修正したら、この基本設計書も必ず修正してください。**
設計書とソースコードの整合性を保つことで、継続的なメンテナンスが可能になります。

---

## 1. システム概要

### 1.1 システムの目的
HP2550気象観測装置から送信される気象データを受信・保存し、Web APIとして外部に提供する気象データ管理システム。

### 1.2 主要機能
- **リアルタイムデータ受信**: HP2550からの気象データをHTTP POSTで受信
- **データベース管理**: MySQL上での気象データ永続化
- **Web API提供**: RESTful APIによるデータアクセス
- **日別集計処理**: 観測データから日別統計を生成 ⭐**新機能追加**
  - 日照時間計算（solar_wm2 >= 150W/m² 基準）
  - UV指数平均値計算
  - 強化されたエラーハンドリング
- **データ移行**: 過去データ（CSV）の一括インポート

### 1.3 技術スタック
- **言語**: PHP 8.0+
- **データベース**: MySQL 8.0+
- **Webサーバー**: Apache/Nginx
- **プロトコル**: HTTP/HTTPS
- **データ形式**: JSON, CSV

---

## 2. システム・アーキテクチャ

### 2.1 設計思想
本システムは**レイヤード・アーキテクチャ**を基盤とし、一部**MVCパターン**の概念を取り入れています。

```
┌─────────────────────────────────────────────────┐
│              Presentation Layer                  │
│  (Web API Endpoints, User Interfaces)           │
├─────────────────────────────────────────────────┤
│               Business Layer                     │
│    (Data Processing, Validation, Logic)          │
├─────────────────────────────────────────────────┤
│              Data Access Layer                   │
│        (Models, Database Operations)             │
├─────────────────────────────────────────────────┤
│                Infrastructure                    │
│    (Database, Logging, Configuration)           │
└─────────────────────────────────────────────────┘
```

### 2.2 アーキテクチャの特徴

#### **関心の分離 (Separation of Concerns)**
- **設定管理**: `config.php`で一元管理
- **データモデル**: `models.php`でデータアクセス抽象化
- **ビジネスロジック**: `utils.php`でデータ処理・変換
- **プレゼンテーション**: 各エンドポイントファイルでHTTP処理

#### **依存性注入 (Dependency Injection)**
- データベース接続を`config.php`で一元化
- モデルクラスがPDOインスタンスを注入される構造

#### **単一責任原則 (Single Responsibility Principle)**
- 各ファイルが明確な責任を持つ
- データ受信、データ変換、データベース操作を分離

---

## 3. ディレクトリ構成と役割 ⭐**2025-08-26更新**

### 3.1 プロジェクト全体構成

```
hp2550/                    # プロジェクトルートディレクトリ
├── Apache/                # Web公開用ファイル群（htdocs配置用）
│   ├── index.php         # メインページ
│   └── weather/          # 気象データシステム本体
│       ├── config.php    # Apache用設定ファイル
│       ├── models.php    # データアクセス層（Model）
│       ├── utils.php     # ビジネスロジック層
│       ├── latest.php    # 最新データ取得API（Controller）
│       ├── stations.php  # ステーション一覧API（Controller）
│       ├── stats.php     # 統計データAPI（Controller）
│       ├── health.php    # ヘルスチェックAPI（Controller）
│       ├── check_db.php  # データベース診断（Utility）
│       ├── init_station.php # 初期セットアップ（Utility）
│       ├── send_current_data.php # テスト用データ送信（Utility）
│       ├── data/         # データ受信エンドポイント
│       └── logs/         # ログファイル格納
├── config.php            # プロジェクト管理用設定ファイル
├── README.md             # プロジェクト概要
├── Database/             # データベース管理・バッチ処理
├── migration/            # データ移行ツール群
├── infomation/           # 仕様書・ドキュメント
├── instructions/         # セットアップガイド
├── tools/                # ユーティリティツール
├── 基本設計/             # 設計ドキュメント
└── data/                 # 既存データファイル（参考）
```

### 3.2 設計思想の変更点

#### **Apache/非Apache分離**
- **Apache/**: Web公開が必要なファイルのみ配置
- **ルート配下**: DB操作・バッチ処理等のプロジェクト管理ファイル
- **セキュリティ向上**: 機密ファイルの非公開化

#### **設定ファイル分離**
- **Apache/weather/config.php**: Web API専用設定
- **hp2550/config.php**: プロジェクト管理用設定

### 3.3 MVCパターンでの分類（更新版）

#### **Model (データ層)**
- **Apache/weather/config.php**: Web API用設定とDB接続
- **hp2550/config.php**: プロジェクト管理用設定とDB接続
- **Apache/weather/models.php**: データアクセスオブジェクト (DAO)
- **Database/**: データベーススキーマとバッチ処理

#### **View (表示層)**
- **Apache/index.php**: プロジェクトメインページ
- **Apache/weather/**: JSON API レスポンス (各エンドポイント)

#### **Controller (制御層)**
- **Apache/weather/latest.php**: 最新データ制御
- **Apache/weather/stations.php**: ステーション管理制御  
- **Apache/weather/stats.php**: 統計データ制御
- **Apache/weather/data/report/index.php**: データ受信制御

#### **Utility (共通機能)**
- **Apache/weather/utils.php**: データ変換・バリデーション
- **Apache/weather/health.php**: システム監視
- **migration/**: データ移行ツール群
- **tools/**: ユーティリティツール群

---

## 4. データフロー

### 4.1 リアルタイムデータ受信フロー

```
HP2550装置 → HTTP POST → Apache/weather/data/report/index.php
    ↓
PASSKEY認証 (WeatherStation Model)
    ↓
データ変換 (EcowittDataProcessor)
    ↓
バリデーション (DataValidator)
    ↓
データベース保存 (WeatherObservation Model)
    ↓
レスポンス返却 (200 OK)
```

### 4.2 API データ取得フロー

```
外部リクエスト → API Endpoint (Apache/weather/latest.php等)
    ↓
パラメータ検証
    ↓
データベース検索 (Model)
    ↓
JSON整形・出力
```

### 4.3 日別集計処理フロー

```
定時実行 → Database/daily_aggregation.php
    ↓
未集計日付検出
    ↓
calculateDailySummary() (集計計算)
    ↓
saveDailySummary() (結果保存)
    ↓
進捗レポート出力
```

---

## 5. データベース設計

### 5.1 主要テーブル

#### **weather_station** (ステーション管理)
- 気象ステーションの基本情報
- PASSKEY認証情報（SHA-256ハッシュ）
- 位置情報・メタデータ

#### **weather_observation** (観測データ)
- リアルタイム気象観測値
- 温度、湿度、気圧、風速、降水量、日射量等
- 時系列データ（time_utc がプライマリキー）

#### **daily_weather_summary** (日別集計)
- 日別統計データ（最高/最低/平均値）
- 特定時刻（9時、15時、21時）の観測値
- バッチ処理により自動生成

### 5.2 データ関係

```
weather_station (1) ←→ (N) weather_observation
weather_station (1) ←→ (N) daily_weather_summary
```

---

## 6. セキュリティ設計

### 6.1 認証・認可
- **PASSKEY認証**: SHA-256ハッシュによるステーション認証
- **IPアドレス制限**: 設定により送信元制限可能
- **CORS設定**: クロスオリジンアクセス制御

### 6.2 データ保護
- **SQLインジェクション対策**: PDO Prepared Statements使用
- **XSS対策**: JSON出力時のエスケープ処理
- **ログ管理**: 機密情報（PASSKEY等）のログ除外

---

## 7. 保守・運用設計

### 7.1 ログ管理 ⭐**強化済み**
- レベル別ログ出力（DEBUG/INFO/WARNING/ERROR）
- 自動ローテーション（10MB単位）
- 構造化ログ（JSON形式）
- **SQL文特定可能なエラーログ**: エラー発生時にSQL文を識別
- **コンテキスト情報付きログ**: 詳細なパラメータ情報記録

### 7.2 監視・診断
- `health.php`: システムヘルスチェック
- `check_db.php`: データベース接続診断
- `stats.php`: システム統計情報

### 7.3 バックアップ・災害対策
- `backup_database_simple.bat`: データベース自動バックアップ
- `restore_database.bat`: データベース復旧スクリプト

---

## 8. 拡張性・将来計画

### 8.1 スケーラビリティ
- **水平スケーリング**: 複数ステーション対応済み
- **データ分割**: 日別集計による高速化
- **キャッシュ戦略**: 必要に応じてRedis導入可能

### 8.2 機能拡張
- **アラート機能**: 異常値検知・通知
- **予測機能**: 機械学習による天気予報
- **可視化**: グラフ・チャート表示機能

---

## 9. 開発・デプロイメント

### 9.1 開発環境セットアップ
- `instructions/installation_guide.md`参照
- `instructions/environment_setup.md`参照

### 9.2 本番デプロイメント
1. データベース作成: `Database/create_tables.sql`実行
2. 設定ファイル調整: `config.php`の環境変数設定
3. Webサーバー設定: DocumentRoot設定
4. 定期実行設定: `setup_task_scheduler.bat`実行

---

## 10. バージョン管理・変更履歴

### 10.1 変更管理プロセス
1. **ソースコード修正**
2. **この設計書の更新** ← **必須**
3. **テスト実行**
4. **本番反映**

### 10.2 ドキュメント更新ルール
- 新機能追加時: システム概要・機能一覧を更新
- アーキテクチャ変更時: 設計思想・データフロー図を更新
- API変更時: エンドポイント一覧を更新
- データベース変更時: テーブル構成を更新

---

---

## 11. 最新修正情報

### 11.1 フォルダ構成整理（2025-08-26実施）
- **Apache/非Apache分離**: セキュリティ向上
- **設定ファイル分離**: 用途別config.php管理
- **プロジェクト構造最適化**: 保守性向上

### 11.2 Phase 1-3 修正概要（2025-08-26実施）
- **SQLSTATE[HY093]エラー完全解消**
- **新機能実装**: 日照時間・UV指数平均計算
- **データベーススキーマ最適化**: 不要カラム14列削除
- **エラーハンドリング全面強化**

### 11.3 主要変更ファイル
- **フォルダ構成**: 全体的なディレクトリ再編成
- **Database/daily_aggregation_functions.php**: 全面改修
- **Database/create_tables.sql**: スキーマ最適化
- **config.php**: Apache用とプロジェクト管理用に分離

### 11.4 動作確認済み
- ✅ フォルダ構成整理完了
- ✅ パス修正完了（require_once等）
- ✅ 2020-12-15（正常日）完全動作
- ✅ 2020-12-16（旧問題日）エラー解消確認
- ✅ 新機能（日照時間・UV平均）正常計算
- ✅ パフォーマンス良好（1.4-1.8秒/288件処理）

---

**最終更新: 2025-08-26**
**更新者: Claude Code**  
**バージョン: 1.2 - フォルダ構成整理 + Phase 1-3 完了版**
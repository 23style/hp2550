# HP2550 気象データ管理システム 開発ガイドライン

## ⚠️ 重要な注意事項
**ソースファイルを修正したら、この開発ガイドラインの該当箇所も必ず確認・更新してください。**

---

## 1. コーディング規約

### 1.1 PHP コーディングスタイル
本プロジェクトは **PSR-12** に基づくコーディングスタイルを採用しています。

#### インデント・フォーマット
```php
<?php
// ✅ 正しい例
class WeatherStation {
    private $pdo;
    
    public function __construct() {
        $this->pdo = getDBConnection();
    }
    
    public function findByPasskey($passkey) {
        $stmt = $this->pdo->prepare("
            SELECT * FROM weather_station 
            WHERE passkey_sha256 = ? AND is_active = 1
        ");
        
        return $stmt->fetch();
    }
}
```

#### 命名規則
- **クラス名**: PascalCase (`WeatherStation`, `DataConverter`)
- **メソッド名**: camelCase (`findByPasskey`, `calculateDailySummary`)
- **変数名**: snake_case (`$station_id`, `$temp_c`)
- **定数名**: UPPER_SNAKE_CASE (`LOG_ENABLED`, `MAX_REQUEST_SIZE`)
- **データベース**: snake_case (`weather_station`, `observation_date`)

---

### 1.2 ファイル構成規約

#### ファイルヘッダー
```php
<?php
/**
 * HP2550 気象データ管理システム [ファイルの役割]
 * 
 * [ファイルの詳細説明]
 * 
 * @author Claude Code
 * @version 1.0
 * @since 2025-08-24
 */
```

#### require文の順序
```php
// 1. 設定ファイル
require_once 'config.php';

// 2. モデルファイル
require_once 'models.php';

// 3. ユーティリティ
require_once 'utils.php';
```

---

### 1.3 データベース操作規約

#### Prepared Statement の必須使用
```php
// ✅ 正しい例
$stmt = $pdo->prepare("SELECT * FROM weather_observation WHERE station_id = ?");
$stmt->execute([$stationId]);

// ❌ 間違った例（SQLインジェクション脆弱性）
$sql = "SELECT * FROM weather_observation WHERE station_id = '$stationId'";
$result = $pdo->query($sql);
```

#### トランザクション使用指針
```php
// データ整合性が重要な操作では必須
try {
    $pdo->beginTransaction();
    
    // 複数のDB操作
    $stmt1->execute();
    $stmt2->execute();
    
    $pdo->commit();
} catch (Exception $e) {
    $pdo->rollback();
    throw $e;
}
```

---

## 2. エラーハンドリング規約

### 2.1 例外処理パターン

#### API エンドポイントでの例外処理
```php
try {
    // メイン処理
    $result = $model->getData($params);
    sendJSON($result);
    
} catch (Exception $e) {
    logError("API処理エラー", [
        'error' => $e->getMessage(),
        'endpoint' => $_SERVER['REQUEST_URI']
    ]);
    sendError('処理中にエラーが発生しました', 500);
}
```

#### バッチ処理での例外処理
```php
foreach ($items as $item) {
    try {
        processItem($item);
        $successCount++;
        
    } catch (Exception $e) {
        $errorCount++;
        error_log("項目処理エラー: " . $e->getMessage());
        // 処理継続
    }
}
```

### 2.2 ログ出力規約

#### ログレベル使い分け
- **DEBUG**: 開発時のデバッグ情報
- **INFO**: 正常な処理の記録
- **WARNING**: 警告（処理継続可能）
- **ERROR**: エラー（処理中断）

```php
// 使用例
logDebug("データ変換開始", ['raw_data' => $rawData]);
logInfo("データ保存成功", ['station_id' => $stationId]);
logWarning("異常値を検出", ['temp' => $temp, 'threshold' => 60]);
logError("データベース接続失敗", ['dsn' => $dsn]);
```

#### 機密情報の除外
```php
// ✅ 正しい例（PASSKEYを除外）
$logData = $requestData;
unset($logData['PASSKEY']);
logInfo("リクエスト受信", $logData);

// ❌ 間違った例（PASSKEY漏洩リスク）
logInfo("リクエスト受信", $requestData);
```

---

## 3. セキュリティガイドライン

### 3.1 認証・認可

#### PASSKEY 処理
```php
// ✅ 正しいPASSKEY処理
$passkey = $_POST['PASSKEY'] ?? '';
$station = $stationModel->findByPasskey($passkey);

if (!$station) {
    logWarning("Invalid PASSKEY attempt", ['ip' => getClientIP()]);
    sendError('Authentication failed', 403);
}

// PASSKEYをログに出力しない
unset($_POST['PASSKEY']);
```

#### データサニタイゼーション
```php
// 入力値の検証とサニタイズ
$stationId = filter_input(INPUT_GET, 'station_id', FILTER_SANITIZE_STRING);
if (!$stationId || strlen($stationId) > 64) {
    sendError('Invalid station_id parameter', 400);
}
```

### 3.2 SQL インジェクション対策

#### 必須対策
- すべてのSQL操作でPrepared Statement使用
- 動的SQL生成の禁止
- 入力値の型・長さ検証

```php
// ✅ 安全なSQL実行
$stmt = $pdo->prepare("
    SELECT * FROM weather_observation 
    WHERE station_id = ? AND DATE(time_utc) = ?
");
$stmt->execute([$stationId, $date]);
```

---

## 4. パフォーマンス最適化指針

### 4.1 データベース最適化

#### インデックス活用
```sql
-- 頻繁に使用される検索条件にはインデックス設定
CREATE INDEX idx_station_time ON weather_observation(station_id, time_utc DESC);
```

#### バッチ処理最適化
```php
// 大量データ処理時はバッチ化
$batchSize = 1000;
for ($offset = 0; $offset < $totalRecords; $offset += $batchSize) {
    $batch = array_slice($records, $offset, $batchSize);
    processBatch($batch);
}
```

### 4.2 メモリ管理

#### 大量データ処理
```php
// ジェネレーターを使用してメモリ効率化
function readLargeDataset($pdo, $query) {
    $stmt = $pdo->prepare($query);
    $stmt->execute();
    
    while ($row = $stmt->fetch()) {
        yield $row;  // メモリ効率的
    }
}
```

---

## 5. 機能追加・修正手順

### 5.1 新機能開発フロー

#### 1. 要件定義・設計
- [ ] 機能仕様書の作成
- [ ] データベース影響の確認
- [ ] API仕様の定義（該当する場合）

#### 2. 実装
- [ ] 該当するファイルの特定
- [ ] コーディング規約の遵守
- [ ] セキュリティ要件の確認

#### 3. テスト
- [ ] 単体テストの実行
- [ ] 統合テストの実行
- [ ] セキュリティテストの実行

#### 4. ドキュメント更新
- [ ] システム設計書の更新
- [ ] ファイル別仕様書の更新
- [ ] API仕様書の更新（該当する場合）

### 5.2 バグ修正フロー

#### 1. 問題分析
- [ ] ログファイルの確認
- [ ] エラーの再現
- [ ] 影響範囲の特定

#### 2. 修正実装
- [ ] 根本原因の対策
- [ ] エラーハンドリングの改善
- [ ] ログ出力の追加・改善

#### 3. 検証
- [ ] 修正内容の動作確認
- [ ] 既存機能への影響確認
- [ ] 本番環境での検証

---

## 6. データベース設計・運用指針

### 6.1 テーブル設計原則

#### 正規化の徹底
- 第3正規形まで正規化
- 重複データの排除
- 参照整合性制約の設定

#### パフォーマンス考慮
```sql
-- 適切なデータ型選択
temp_c DECIMAL(5,2)  -- -999.99 ～ 999.99
time_utc DATETIME    -- 日時専用型
station_id VARCHAR(64)  -- 必要最小限の長さ
```

### 6.2 マイグレーション管理

#### 新テーブル追加時
```sql
-- 必要な制約を含む完全な定義
CREATE TABLE new_table (
    id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
    -- カラム定義
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    PRIMARY KEY (id),
    -- インデックス定義
    -- 外部キー制約
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

#### カラム追加・変更時
```sql
-- 後方互換性を考慮
ALTER TABLE weather_observation 
ADD COLUMN new_field DECIMAL(5,2) NULL COMMENT '新規フィールド';

-- 必要に応じてデフォルト値設定
UPDATE weather_observation SET new_field = 0 WHERE new_field IS NULL;
```

---

## 7. 本番環境デプロイメント

### 7.1 デプロイ前チェックリスト
- [ ] `DEBUG_MODE = false` の設定
- [ ] 本番用データベース設定の確認
- [ ] ログファイルのパーミッション確認
- [ ] バックアップの実行
- [ ] セキュリティ設定の確認

### 7.2 デプロイ後確認事項
- [ ] ヘルスチェックAPI (`health.php`) の動作確認
- [ ] データ受信エンドポイントの動作確認
- [ ] ログ出力の確認
- [ ] 定期実行バッチの動作確認

---

## 8. 障害対応・復旧手順

### 8.1 障害発生時の初動対応

#### 1. 状況確認
```bash
# ヘルスチェック実行
curl http://your-server/health.php

# ログ確認
tail -f logs/weather_receiver.log

# データベース接続確認
php check_db.php
```

#### 2. 緊急対応
- データ受信停止の場合: Webサーバーの再起動
- データベース接続エラー: 接続設定の確認
- ディスク容量不足: ログファイルの整理

### 8.2 復旧手順

#### データベース復旧
```bash
# バックアップからの復旧
mysql -u root -p weather_db < backup_YYYYMMDD.sql

# テーブル構造の確認
mysql -u root -p -e "DESCRIBE weather_observation;"
```

#### 欠損データの補完
- CSV からの再インポート
- 他システムからのデータ取得
- 手動データ投入

---

## 9. 品質管理・テスト指針

### 9.1 コードレビュー項目
- [ ] セキュリティ要件の遵守
- [ ] エラーハンドリングの適切性
- [ ] パフォーマンスへの配慮
- [ ] ログ出力の妥当性
- [ ] コメント・ドキュメントの充実

### 9.2 テスト項目
- [ ] 正常系の動作確認
- [ ] 異常系の動作確認
- [ ] 境界値テスト
- [ ] セキュリティテスト
- [ ] パフォーマンステスト

---

## 10. 継続的改善

### 10.1 定期見直し項目
- パフォーマンス指標の確認
- セキュリティ対策の見直し
- ログ分析による改善点抽出
- 運用コストの最適化

### 10.2 技術的負債管理
- 古いコード・設計の見直し
- 依存関係の更新
- セキュリティアップデート
- パフォーマンス最適化

---

**最終更新: 2025-08-24**
**更新者: Claude Code**
**バージョン: 1.0**
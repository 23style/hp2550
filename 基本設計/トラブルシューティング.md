# HP2550 気象データ管理システム トラブルシューティング・FAQ

## ⚠️ 重要な注意事項
**新しい問題が発生し解決した場合、この文書に追記してください。**
継続的なメンテナンスのため、問題事例とその解決方法を蓄積します。

---

## 1. よくある問題と解決方法

### 1.1 データ受信関連

#### Q: HP2550からのデータが登録されない
**現象**: 観測装置からデータが送信されているが、データベースに保存されない

**診断手順**:
```bash
# 1. ヘルスチェック
curl http://your-server/health.php

# 2. 最新データ確認
curl "http://your-server/latest.php?station_id=AMF_hp2550"

# 3. ログ確認
tail -f logs/weather_receiver.log

# 4. 手動データ送信テスト
curl -X POST http://your-server/data/report/ \
  -d "PASSKEY=your_passkey&dateutc=now&tempf=75.0"
```

**考えられる原因と対策**:
1. **PASSKEY認証エラー**
   - ログに「Invalid PASSKEY attempt」が出力される
   - 対策: PASSKEYの確認、`tools/hash_passkey.php`でハッシュ値確認

2. **データベース接続エラー**
   - ログに「Database connection failed」が出力される
   - 対策: `config.php`の接続設定確認、MySQLサービス状態確認

3. **Webサーバー設定問題**
   - 404エラーが発生
   - 対策: DocumentRoot設定、.htaccessファイル確認

---

### 1.2 データベース関連

#### Q: 日別集計処理がエラーになる
**現象**: `daily_aggregation.php`実行時にエラー発生

**診断手順**:
```bash
# テスト実行
php Database/test_daily_aggregation.php 2025-08-23

# エラーログ確認
cat Database/daily_aggregation.log
```

**既知のエラーと対策**:

1. **LAG関数エラー**
   ```
   ERROR: You cannot use the window function 'lag' in this context
   ```
   - **原因**: MySQL 8.0未満、またはウィンドウ関数とSUMの組み合わせ問題
   - **対策**: `daily_aggregation_functions.php`の該当SQLをシンプル化

2. **関数重複エラー**
   ```
   Fatal error: Cannot redeclare calculateDailySummary()
   ```
   - **原因**: 関数が複数ファイルで定義されている
   - **対策**: 重複する関数定義を削除

3. **特定時刻データの未定義エラー**
   ```
   Warning: Undefined array key "temp_09"
   ```
   - **原因**: 特定時刻(9時、15時、21時)のデータが取得できない
   - **対策**: SQL のTIME関数部分を修正（SUBTIME/ADDTIME使用）

---

### 1.3 API関連

#### Q: APIレスポンスが返されない
**現象**: APIエンドポイントにアクセスしても応答がない

**診断手順**:
```bash
# 基本接続テスト
curl -v http://your-server/health.php

# ログ確認
tail -f logs/weather_receiver.log
tail -f /var/log/apache2/error.log  # Apache使用時
```

**考えられる原因と対策**:
1. **PHPエラー**
   - Fatal errorによる処理停止
   - 対策: エラーログ確認、構文チェック

2. **メモリ不足**
   - 大量データ処理時のメモリ枯渇
   - 対策: `php.ini`のmemory_limit増加、バッチサイズ調整

3. **データベースロック**
   - 長時間実行クエリによるロック
   - 対策: 実行中クエリの確認・停止

---

### 1.4 パフォーマンス関連

#### Q: データ取得が遅い
**現象**: API応答が遅い、タイムアウトが発生

**診断手順**:
```sql
-- 実行中のクエリ確認
SHOW PROCESSLIST;

-- スロークエリの確認
SHOW VARIABLES LIKE 'slow_query_log';
```

**対策**:
1. **インデックス最適化**
   ```sql
   -- 頻繁に使用される検索条件の確認
   EXPLAIN SELECT * FROM weather_observation 
   WHERE station_id = 'AMF_hp2550' AND time_utc > '2025-08-01';
   
   -- 必要に応じてインデックス追加
   CREATE INDEX idx_station_time ON weather_observation(station_id, time_utc);
   ```

2. **クエリ最適化**
   - 不要なカラムの除外
   - LIMIT句の使用
   - 適切なJOIN使用

3. **データ分割**
   - 古いデータのアーカイブ
   - パーティショニングの検討

---

## 2. エラーメッセージ別対処法

### 2.1 データベースエラー

#### `SQLSTATE[HY000] [2002] Connection refused`
- **原因**: MySQLサービス停止
- **対策**: 
  ```bash
  # Windows
  net start mysql80
  
  # Linux
  sudo systemctl start mysql
  ```

#### `SQLSTATE[42S02]: Base table or view not found`
- **原因**: 必要なテーブルが存在しない
- **対策**: `Database/create_tables.sql`の実行

#### `SQLSTATE[23000]: Integrity constraint violation`
- **原因**: 外部キー制約違反、重複キー挿入
- **対策**: データ整合性確認、ON DUPLICATE KEY UPDATE使用

---

### 2.2 PHPエラー

#### `Fatal error: Uncaught Error: Class 'PDO' not found`
- **原因**: PDO拡張が無効
- **対策**: `php.ini`でPDO拡張を有効化

#### `Warning: file_put_contents(): failed to open stream`
- **原因**: ログファイル書き込み権限不足
- **対策**: ディレクトリ・ファイルの権限設定

#### `Fatal error: Maximum execution time exceeded`
- **原因**: スクリプト実行時間制限
- **対策**: `php.ini`のmax_execution_time増加、または`set_time_limit(0)`使用

---

### 2.3 HTTP・ネットワークエラー

#### `404 Not Found`
- **原因**: URL パス設定エラー、.htaccessファイル問題
- **対策**: Webサーバー設定確認、DocumentRoot設定

#### `500 Internal Server Error`
- **原因**: PHP Fatal Error、設定ファイルエラー
- **対策**: エラーログ確認、`config.php`設定確認

#### `403 Forbidden`
- **原因**: PASSKEY認証失敗、IP制限
- **対策**: PASSKEY確認、IP設定確認

---

## 3. メンテナンス・運用問題

### 3.1 定期実行関連

#### Q: 日別集計が自動実行されない
**現象**: 定時バッチが実行されない

**診断手順**:
```bash
# Windows Task Scheduler確認
schtasks /query /tn "HP2550 Daily Aggregation"

# バッチファイル単体実行テスト
cd C:\myWork\dev\hp2550\weather\Database
run_daily_aggregation.bat
```

**対策**:
1. **タスクスケジューラー設定問題**
   - `setup_task_scheduler.bat`の再実行
   - タスクの有効化確認

2. **権限問題**
   - 実行ユーザーの権限確認
   - データベースアクセス権限確認

3. **パス設定問題**
   - バッチファイル内のパス確認
   - 相対パス・絶対パスの適切な使用

---

### 3.2 ログ・監視関連

#### Q: ログファイルが巨大化する
**現象**: ログファイルサイズが異常に大きい

**対策**:
1. **ログローテーション設定**
   ```php
   // config.php での設定確認
   define('LOG_MAX_SIZE', 10 * 1024 * 1024); // 10MB
   ```

2. **ログレベル調整**
   ```php
   // 本番環境でのログレベル設定
   define('LOG_LEVEL', 'WARNING'); // DEBUG出力を抑制
   ```

3. **古いログファイル削除**
   ```bash
   # 30日以上古いログファイル削除
   find logs/ -name "*.log.*" -mtime +30 -delete
   ```

---

## 4. データ整合性・品質問題

### 4.1 データ異常値

#### Q: 明らかに異常な観測値が保存される
**現象**: 気温が-100℃や200℃など異常値

**診断手順**:
```sql
-- 異常値検索
SELECT * FROM weather_observation 
WHERE temp_c < -50 OR temp_c > 60 
ORDER BY time_utc DESC LIMIT 10;
```

**対策**:
1. **バリデーション強化**
   ```php
   // utils.php の DataValidator クラス確認
   public static function validateTemperature($tempC) {
       return $tempC >= -40 && $tempC <= 60;
   }
   ```

2. **異常値の手動修正・削除**
   ```sql
   -- 異常値削除
   DELETE FROM weather_observation 
   WHERE temp_c < -50 OR temp_c > 60;
   ```

---

### 4.2 データ欠損

#### Q: 特定期間のデータが欠損している
**現象**: 一定期間のデータが存在しない

**診断手順**:
```sql
-- 日別データ件数確認
SELECT DATE(time_utc) as date, COUNT(*) as count
FROM weather_observation 
WHERE station_id = 'AMF_hp2550'
    AND time_utc >= '2025-08-01'
GROUP BY DATE(time_utc)
ORDER BY date;
```

**対策**:
1. **CSVからの再インポート**
   ```bash
   cd migration/
   php import_csv.php backup_data.csv AMF_hp2550
   ```

2. **手動データ補完**
   - 前後の値から内挿
   - 他の気象データソースからの補完

---

## 5. セキュリティ関連

### 5.1 不正アクセス対策

#### Q: 大量の不正アクセスログが記録される
**現象**: ログに大量の「Invalid PASSKEY attempt」が記録

**対策**:
1. **IP制限の実装**
   ```php
   // config.php での IP制限例
   $allowedIPs = ['192.168.1.100', '10.0.0.50'];
   $clientIP = $_SERVER['REMOTE_ADDR'];
   
   if (!in_array($clientIP, $allowedIPs)) {
       sendError('Access denied', 403);
   }
   ```

2. **PASSKEY の変更**
   ```bash
   # 新しいPASSKEY生成
   php tools/hash_passkey.php new_passkey_12345
   ```

---

## 6. 緊急時対応手順

### 6.1 システム全体停止時

#### 緊急対応チェックリスト
- [ ] Webサーバーサービス状態確認・再起動
- [ ] MySQLサービス状態確認・再起動
- [ ] ディスク容量確認
- [ ] ログファイル確認
- [ ] ネットワーク接続確認

#### 復旧手順
1. **最小限の動作確認**
   ```bash
   curl http://localhost/health.php
   ```

2. **データベース整合性確認**
   ```bash
   php check_db.php
   ```

3. **データ受信テスト**
   ```bash
   php send_current_data.php
   ```

---

### 6.2 データ破損時

#### データベース復旧
```bash
# 1. バックアップの確認
ls -la Database/backup_*.sql

# 2. 現在のデータベースのバックアップ
mysqldump -u root -p weather_db > emergency_backup.sql

# 3. 最新バックアップからの復旧
mysql -u root -p weather_db < Database/backup_YYYYMMDD.sql

# 4. データ整合性確認
php check_db.php
```

---

## 7. パフォーマンス最適化

### 7.1 データベース最適化

#### 定期メンテナンス
```sql
-- テーブル最適化
OPTIMIZE TABLE weather_observation;
OPTIMIZE TABLE weather_station;
OPTIMIZE TABLE daily_weather_summary;

-- インデックス統計更新
ANALYZE TABLE weather_observation;
```

#### 古いデータの整理
```sql
-- 1年以上古い観測データのアーカイブ（必要に応じて）
CREATE TABLE weather_observation_archive AS
SELECT * FROM weather_observation 
WHERE time_utc < DATE_SUB(NOW(), INTERVAL 1 YEAR);

DELETE FROM weather_observation 
WHERE time_utc < DATE_SUB(NOW(), INTERVAL 1 YEAR);
```

---

## 8. 新しい問題の記録テンプレート

### 問題記録フォーマット
新しい問題が発生した場合、以下の形式で記録してください：

```markdown
#### Q: [問題の概要]
**現象**: [具体的な症状・エラーメッセージ]

**発生日時**: YYYY-MM-DD HH:MM:SS
**環境**: [OS、PHP、MySQLバージョン等]

**診断手順**:
[実行したコマンド・確認手順]

**原因**: [根本原因の特定結果]

**対策**: [実施した解決方法]

**予防策**: [再発防止のための措置]
```

---

## 9. 連絡先・参考資料

### 9.1 公式ドキュメント
- PHP公式: https://www.php.net/docs.php
- MySQL公式: https://dev.mysql.com/doc/
- HP2550仕様: `infomation/hp2550_sendingdata.md`

### 9.2 システム固有資料
- システム設計書: `基本設計/システム設計書.md`
- ファイル別仕様書: `基本設計/ファイル別仕様書.md`
- 開発ガイドライン: `基本設計/開発ガイドライン.md`

---

**最終更新: 2025-08-24**
**更新者: Claude Code**  
**バージョン: 1.0**

## 📝 更新履歴
| 日付 | 更新者 | 更新内容 |
|------|--------|----------|
| 2025-08-24 | Claude Code | 初版作成 |